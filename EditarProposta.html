<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nova P√°gina</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="style4.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="agrupa.js" defer></script>
  <script src="criarProposta.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    .grupo-campos-numericos {
  display: flex;
  justify-content: center;         /* Alinhamento central */
  gap: 30px;
  margin-top: 10px;
  margin-bottom: 15px;
}

.grupo-campos-numericos label {
  font-weight: bold;
  margin-right: 5px;
}

.grupo-campos-numericos input[type="number"] {
  width: 80px;
  padding: 5px 10px;
  border: 1px solid #ccc;
  border-radius: 12px;             /* Borda arredondada */
  text-align: center;
  font-size: 14px;
}

    body { padding-bottom: 80px; }
    .valor-destaque {
      padding: 12px 20px; background-color: #f8f9fa; border-radius: 8px;
      font-weight: 600; white-space: nowrap;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.04);
      display: inline-block;
    }
    .totais-fixos {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background-color: #ffffff;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
      padding: 10px 20px; display: none;
      z-index: 1000;
    }
    .sidebar {
      width: 240px; position: fixed; top: 0; left: 0;
      height: 100%; background-color: #343a40;
      color: white; padding: 20px;
    }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li a {
      color: white; display: flex; align-items: center;
      padding: 10px 0; text-decoration: none;
    }
    .sidebar-footer { margin-top: 40px; }
    .sidebar-button {
      width: 100%; background-color: #495057; color: white;
      border: none; padding: 10px;
      display: flex; align-items: center; gap: 8px;
    }
    .content { margin-left: 260px; padding: 20px; }
    .topbar {
      display: flex; justify-content: space-between;
      align-items: center;
    }
    .search-container {
      margin: 20px 0; display: flex;
      align-items: center; gap: 10px;
    }
    .search-container input {
      flex: 1; padding: 8px;
    }
    .grupo-controles { margin-bottom: 20px; }
    .table-container { margin-bottom: 40px; }
  </style>
</head>
<body>


    
    
  <aside class="sidebar">
    <ul>
      <li><li><a href="../pages/listagem.html"><span class="material-icons-outlined">home</span> In√≠cio</a></li></li>
      <li><a href="#"><span class="material-icons-outlined">folder</span> Meus Arquivos</a></li>
      <li><a href="#"><span class="material-icons-outlined">settings</span> Configura√ß√µes</a></li>
      <li><a href="#"><span class="material-icons-outlined">logout</span> Logout</a></li>
    </ul>
    <div class="sidebar-footer">
      <button onclick="salvarProdutoBase()" id="save-proposal" class="sidebar-button">
        <span class="material-icons-outlined">save</span> Salvar Proposta
      </button>
      <button onclick="gerarOrcamentoParaImpressao()" class="sidebar-button">
        <span class="material-icons-outlined">print</span> Imprimir Envio
      </button>
   
     

      
      
    </div>
  </aside>
  <main class="content">
  
<!-- Link para os √≠cones Material Symbols (coloque no <head> se ainda n√£o tiver) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <div id="popup-info" class="popup-info" data-group-id="" style="display: none;">
    <div class="popup-content">
      <h3 id="popup-title">Informa√ß√µes Adicionais</h3>
  
      <div class="popup-grid">
        <!-- 1. Miudezas (R$) -->
        <div class="form-group">
          <label for="popup_miudezas">
            Miudezas (R$)
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_miudezas')" title="Copiar vari√°vel #popup_miudezas" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_miudezas" data-tag="miudezas" placeholder="R$ 0,00">
        </div>
  
        <!-- 2. Gasto Operacional (%) -->
        <div class="form-group">
          <label for="popup_gasto_operacional">
            % Gasto Operacional
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_gasto_operacional')" title="Copiar vari√°vel #popup_gasto_operacional" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_gasto_operacional" data-tag="gasto_operacional" placeholder="Ex: 33%">
        </div>
  
        <!-- 3. Impostos (%) -->
        <div class="form-group">
          <label for="popup_impostos">
            % Impostos
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_impostos')" title="Copiar vari√°vel #popup_impostos" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_impostos" data-tag="impostos" placeholder="Ex: 12,19%">
        </div>
  
        <!-- 4. Margem de Lucro (%) -->
        <div class="form-group">
          <label for="popup_margem_lucro">
            % Margem de Lucro
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_margem_lucro')" title="Copiar vari√°vel #popup_margem_lucro" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_margem_lucro" data-tag="margem_lucro" placeholder="Ex: 20%">
        </div>
  
        <!-- 5. Margem de Seguran√ßa (%) -->
        <div class="form-group">
          <label for="popup_margem_seguranca">
            % Margem de Seguran√ßa
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_margem_seguranca')" title="Copiar vari√°vel #popup_margem_seguranca" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_margem_seguranca" data-tag="margem_seguranca" placeholder="Ex: 5%">
        </div>
  
        <!-- 6. Comiss√£o Arquiteta (%) -->
        <div class="form-group">
          <label for="popup_comissao_arquiteta">
            % Comiss√£o Arquiteta
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_comissao_arquiteta')" title="Copiar vari√°vel #popup_comissao_arquiteta" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_comissao_arquiteta" data-tag="comissao_arquiteta" placeholder="Ex: 3%">
        </div>
  
        <!-- 7. Margem de Negocia√ß√£o (R$) -->
        <div class="form-group">
          <label for="popup_margem_negociacao">
            Margem de Negocia√ß√£o (R$)
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_margem_negociacao')" title="Copiar vari√°vel #popup_margem_negociacao" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_margem_negociacao" data-tag="margem_negociacao" placeholder="Ex: R$ 100,00">
        </div>
  
        <!-- Campos Livres -->
        <div class="form-group">
          <label for="popup_altura_montante">
            Altura Montante/Vidro (m)
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_altura_montante')" title="Copiar vari√°vel #popup_altura_montante" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_altura_montante" data-tag="altura_montante" placeholder="Ex: 2.10">
        </div>
  
        <div class="form-group">
          <label for="popup_numero_montantes">
            N√∫mero de Montantes
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_numero_montantes')" title="Copiar vari√°vel #popup_numero_montantes" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_numero_montantes" data-tag="numero_montantes" placeholder="Ex: 4">
        </div>
  
        <div class="form-group">
          <label for="popup_numero_protecoes">
            N√∫mero de Prote√ß√µes
            <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_numero_protecoes')" title="Copiar vari√°vel #popup_numero_protecoes" style="cursor: pointer;">content_copy</span>
          </label>
          <input type="text" id="popup_numero_protecoes" data-tag="numero_protecoes" placeholder="Ex: 2">
        </div>
      </div>
  
      <!-- Campo de descri√ß√£o livre -->
      <div class="form-group full-width">
        <label for="popup_descricao">
          Unidade
          <span class="material-symbols-outlined copy-icon" onclick="copiarTag('popup_descricao')" title="Copiar vari√°vel #popup_descricao" style="cursor: pointer;">content_copy</span>
        </label>
        <textarea id="popup_descricao" data-tag="descricao" rows="1" placeholder="Digite a descri√ß√£o..."></textarea>
      </div>
  
      <button onclick="fecharPopup()" class="btn btn-secondary mt-3">Fechar</button>
    </div>
  </div>
  
  
    <header class="topbar">
      <h2>Compor Produto</h2>
      <img src="logo-redonda.png" alt="Logo" class="logo-round" height="50">
    </header>
  <!-- Formul√°rio -->
<br>
  <form id="novoOrcamentoForm">
    <!-- INFORMA√á√ïES DO OR√áAMENTO -->
    <div class="accordion mb-3" id="accordionOrcamento">

      <!-- Aba: Informa√ß√µes do Or√ßamento -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInfoOrcamento">
            Informa√ß√µes do Or√ßamento
          </button>
        </h2>
        <div id="collapseInfoOrcamento" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <div class="row g-3">
              <script>
  function gerarNumeroOrcamento() {
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const ano = hoje.getFullYear();

    const aleatorio = Array.from({ length: 5 }, () =>
      Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g, '').charAt(0)
    ).join('');

    return `${dia}-${ano}-${aleatorio}`;
  }

  window.addEventListener("DOMContentLoaded", () => {
    const campoNumero = document.getElementById("numeroOrcamento");
    if (campoNumero && !campoNumero.value) {
      campoNumero.value = gerarNumeroOrcamento();
    }
  });
</script>

              <div class="col-md-4">
                <label class="form-label">N√∫mero do Or√ßamento</label>
                <input type="text" class="form-control" id="numeroOrcamento" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Data do Or√ßamento</label>
                <input type="date" class="form-control" id="dataOrcamento" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Origem do Cliente</label>
                <select class="form-select" id="origemCliente" required>
                  <option value="">Selecione</option>
                  <option>Arquiteto(a)</option>
                  <option>Construtora</option>
                  <option>Engenheiro(a)</option>
                  <option>Google</option>
                  <option>Instagram</option>
                  <option>Indica√ß√£o</option>
                  <option>J√° √© cliente</option>
                  <option>Licita√ß√£o</option>
                  <option>Outros</option>
                </select>
              </div>

              <!-- Nome + Autocomplete -->
              <div class="col-md-6 position-relative">
                <label for="nomeOrigem" class="form-label">Nome Arquiteto/Construtora/Engenheiro</label>
                <input type="text" class="form-control" id="nomeOrigem" placeholder="Digite para buscar..." autocomplete="off">
                <ul id="sugestoesOrigem" class="list-group position-absolute w-100 shadow bg-white" style="z-index: 10; max-height: 200px; overflow-y: auto; display: none;"></ul>
              </div>
              <div class="col-md-3">
                <label class="form-label">C√≥digo Omie</label>
                <input type="text" class="form-control" id="codigoOrigem" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label">Telefone Origem</label>
                <input type="text" class="form-control" id="telefoneOrigem">
              </div>
              <div class="col-md-3">
                <label class="form-label">E-mail Origem</label>
                <input type="email" class="form-control" id="emailOrigem">
              </div>
              <div class="col-md-3">
                <label class="form-label">% Comiss√£o Arquiteto</label>
                <input type="number" class="form-control" id="comissaoArquiteto" step="0.01" min="0" max="100">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Dados do Cliente -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCliente">
            Dados do Cliente
          </button>
        </h2>
        <div id="collapseCliente" class="accordion-collapse collapse">
          <div class="accordion-body">
           <div id="clientesWrapper">
 <div id="clientesWrapper">
  <div class="row g-3 cliente-item">
    <div class="col-md-6 position-relative">
      <label class="form-label">Nome / Raz√£o Social</label>
      <input type="text" class="form-control razaoSocial" placeholder="Digite para buscar..." autocomplete="off">
      <ul class="sugestoesCliente list-group position-absolute w-100 shadow bg-white" style="z-index: 10; max-height: 200px; overflow-y: auto; display: none;"></ul>
    </div>
    <div class="col-md-6">
      <label class="form-label">C√≥digo Omie</label>
      <input type="text" class="form-control codigoCliente" readonly>
    </div>
    <div class="col-md-6">
      <label class="form-label">CPF / CNPJ</label>
      <input type="text" class="form-control cpfCnpj" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Fun√ß√£o</label>
      <input type="text" class="form-control funcaoCliente">
    </div>
    <div class="col-md-6">
      <label class="form-label">Telefone</label>
      <input type="text" class="form-control telefoneCliente">
    </div>
  </div>
  <br>
</div>
</div>

<button type="button" class="btn btn-outline-primary mt-2" onclick="adicionarClienteRelacionado()">Adicionar Cliente Relacionado</button>
          </div>
        </div>
      </div>
<script>
  function aplicarAutocompleteCliente(container) {
    const input = container.querySelector(".razaoSocial");
    const codigoInput = container.querySelector(".codigoCliente");
    const cpfInput = container.querySelector(".cpfCnpj");
    const sugestoes = container.querySelector(".sugestoesCliente");

    input.addEventListener("input", async () => {
      const termo = input.value.trim();
      if (termo.length < 3) {
        sugestoes.style.display = "none";
        return;
      }
      try {
        const resposta = await fetch("https://ulhoa-0a02024d350a.herokuapp.com/clientes/visualizar");
        const clientes = await resposta.json();
        const resultados = clientes.filter(c =>
          (c.nome_fantasia || "").toLowerCase().includes(termo.toLowerCase()) ||
          (c.razao_social || "").toLowerCase().includes(termo.toLowerCase())
        );
        sugestoes.innerHTML = "";
        resultados.forEach(cliente => {
          const item = document.createElement("li");
          item.className = "list-group-item list-group-item-action";
          item.textContent = cliente.nome_fantasia || cliente.razao_social;
          item.dataset.nome = cliente.nome_fantasia || cliente.razao_social;
          item.dataset.codigo = cliente.codigo_cliente_omie || "";
          item.dataset.cpfcnpj = cliente.cnpj_cpf || "";
          item.dataset.telefone = cliente.telefone || "";
          item.addEventListener("click", () => {
            input.value = item.dataset.nome;
            codigoInput.value = item.dataset.codigo;
            cpfInput.value = item.dataset.cpfcnpj;
            const telefoneInput = container.querySelector(".telefoneCliente");
            if (telefoneInput) telefoneInput.value = item.dataset.telefone;
            sugestoes.style.display = "none";
          });
          sugestoes.appendChild(item);
        });
        sugestoes.style.display = resultados.length ? "block" : "none";
      } catch (error) {
        console.error("Erro ao buscar clientes:", error);
        sugestoes.style.display = "none";
      }
    });

    document.addEventListener("click", (e) => {
      if (!sugestoes.contains(e.target) && e.target !== input) {
        sugestoes.style.display = "none";
      }
    });
  }

  function adicionarClienteRelacionado() {
    const wrapper = document.getElementById("clientesWrapper");
    const novo = wrapper.firstElementChild.cloneNode(true);
    novo.querySelectorAll("input").forEach(input => input.value = "");
    const cnpjGroup = novo.querySelector(".cpfCnpj").closest(".col-md-6");
    if (cnpjGroup) cnpjGroup.remove(); // Remove CPF/CNPJ para os seguintes
    const br = document.createElement("br");
    wrapper.appendChild(br);
    wrapper.appendChild(novo);
    aplicarAutocompleteCliente(novo);
  }

  window.addEventListener("DOMContentLoaded", () => {
    const primeiroCliente = document.querySelector(".cliente-item");
    if (primeiroCliente) aplicarAutocompleteCliente(primeiroCliente);
  });
</script>

<script>
  function aplicarAutocompleteCliente(container) {
    const input = container.querySelector(".razaoSocial");
    const codigoInput = container.querySelector(".codigoCliente");
    const cpfInput = container.querySelector(".cpfCnpj");
    const telefoneInput = container.querySelector(".telefoneCliente");
    const sugestoes = container.querySelector(".sugestoesCliente");

    input.addEventListener("input", async () => {
      const termo = input.value.trim();
      if (termo.length < 3) {
        sugestoes.style.display = "none";
        return;
      }
      try {
        const resposta = await fetch("https://ulhoa-0a02024d350a.herokuapp.com/clientes/visualizar");
        const clientes = await resposta.json();
        const resultados = clientes.filter(c =>
          (c.nome_fantasia || "").toLowerCase().includes(termo.toLowerCase()) ||
          (c.razao_social || "").toLowerCase().includes(termo.toLowerCase())
        );
        sugestoes.innerHTML = "";
        resultados.forEach(cliente => {
          const item = document.createElement("li");
          item.className = "list-group-item list-group-item-action";
          item.textContent = cliente.nome_fantasia || cliente.razao_social;
          item.dataset.nome = cliente.nome_fantasia || cliente.razao_social;
          item.dataset.codigo = cliente.codigo_cliente_omie || "";
          item.dataset.cpfcnpj = cliente.cnpj_cpf || "";
          item.dataset.telefone = cliente.telefone1_numero || "";
          item.addEventListener("click", () => {
            input.value = item.dataset.nome;
            codigoInput.value = item.dataset.codigo;
            cpfInput.value = item.dataset.cpfcnpj;
            if (telefoneInput) {
              telefoneInput.value = item.dataset.telefone;
            }
            const telefoneInput = container.querySelector(".telefoneCliente");
            if (telefoneInput) telefoneInput.value = item.dataset.telefone;
            sugestoes.style.display = "none";
          });
          sugestoes.appendChild(item);
        });
        sugestoes.style.display = resultados.length ? "block" : "none";
      } catch (error) {
        console.error("Erro ao buscar clientes:", error);
        sugestoes.style.display = "none";
      }
    });

    document.addEventListener("click", (e) => {
      if (!sugestoes.contains(e.target) && e.target !== input) {
        sugestoes.style.display = "none";
      }
    });
  }

  function adicionarClienteRelacionado() {
    const wrapper = document.getElementById("clientesWrapper");
    const novo = wrapper.firstElementChild.cloneNode(true);
    novo.querySelectorAll("input").forEach(input => input.value = "");
    const cnpjGroup = novo.querySelector(".cpfCnpj").closest(".col-md-6");
    if (cnpjGroup) cnpjGroup.remove(); // Remove CPF/CNPJ para os seguintes
    const br = document.createElement("br");
    wrapper.appendChild(br);
    wrapper.appendChild(novo);
    aplicarAutocompleteCliente(novo);
  }

  window.addEventListener("DOMContentLoaded", () => {
    const primeiroCliente = document.querySelector(".cliente-item");
    if (primeiroCliente) aplicarAutocompleteCliente(primeiroCliente);
  });
</script>





      <!-- Aba: Endere√ßo da Obra -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEndereco">
            Endere√ßo da Obra
          </button>
        </h2>
        <div id="collapseEndereco" class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">CEP</label>
                <input type="text" class="form-control" id="cep">
              </div>
              <div class="col-md-6">
                <label class="form-label">Rua / Avenida</label>
                <input type="text" class="form-control" id="rua">
              </div>
              <div class="col-md-3">
                <label class="form-label">N√∫mero</label>
                <input type="text" class="form-control" id="numero">
              </div>
              <div class="col-md-4">
                <label class="form-label">Complemento</label>
                <input type="text" class="form-control" id="complemento">
              </div>
              <div class="col-md-4">
                <label class="form-label">Bairro</label>
                <input type="text" class="form-control" id="bairro">
              </div>
              <div class="col-md-2">
                <label class="form-label">Cidade</label>
                <input type="text" class="form-control" id="cidade">
              </div>
              <div class="col-md-2">
                <label class="form-label">Estado</label>
                <input type="text" class="form-control" id="estado">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Equipe Interna -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEquipe">
            Equipe Interna
          </button>
        </h2>
        <div id="collapseEquipe" class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-6">
  <label class="form-label">Vendedor Respons√°vel</label>
  <select class="form-select" id="vendedorResponsavel" required>
    <option value="">Carregando...</option>
  </select>
</div>
<script>
  async function carregarVendedores() {
    try {
      const select = document.getElementById("vendedorResponsavel");
      const resposta = await fetch("https://ulhoa-0a02024d350a.herokuapp.com/api/vendedores");
      const vendedores = await resposta.json();

      select.innerHTML = '<option value="">Selecione um vendedor</option>';
      vendedores.forEach(vendedor => {
        const option = document.createElement("option");
        option.value = vendedor._id;
        option.textContent = vendedor.nome;
        select.appendChild(option);
      });
    } catch (erro) {
      console.error("Erro ao carregar vendedores:", erro);
      document.getElementById("vendedorResponsavel").innerHTML =
        '<option value="">Erro ao carregar</option>';
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    carregarVendedores();
  });
</script>

              <div class="col-md-6">
                <label class="form-label">Operador (Usu√°rio Interno)</label>
                <input type="text" class="form-control" id="operadorInterno">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Produtos e Condi√ß√µes -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProdutos">
            Produtos, Prazos e Condi√ß√µes
          </button>
        </h2>
        <div id="collapseProdutos" class="accordion-collapse collapse">
          <div class="accordion-body">
            
            <div class="mb-3">
              <label class="form-label">Prazos por √Årea (din√¢mico)</label>
              <textarea class="form-control" id="prazosArea"  placeholder="Estrutura
√Årea ___: _____ dias uteis ap√≥s aprova√ß√£o do respectivo projeto

Vidro
√Årea ___: _____ dias uteis ap√≥s instala√ß√£o da respectiva¬†estrutura"rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Condi√ß√£o de Pagamento</label>
              <input type="text" class="form-control" id="condicaoPagamento">
            </div>
     <div class="mb-3">
  <label class="form-label">Condi√ß√µes Gerais (Escolha um modelo ou edite)</label>

  <div class="d-flex flex-wrap gap-2 mb-2">
    <button type="button" class="btn btn-outline-primary" onclick="preencherCondicoesComInstalacao()">
      Or√ßamento com medi√ß√£o e instala√ß√£o
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="preencherCondicoesSemInstalacao()">
      Or√ßamento sem medi√ß√£o e instala√ß√£o
    </button>
    <button type="button" class="btn btn-outline-warning" onclick="preencherCondicoesSemTampo()">
      N√£o incluso tampo
    </button>
  </div>

  <textarea
    class="form-control"
    id="condicoesGerais"
    rows="10"
    style="min-height: 240px; resize: vertical;"
    placeholder="Escolha uma op√ß√£o ou edite manualmente...">
  </textarea>
</div>
        </div>
      </div>

    </div>
  </form>
</div>




<script>
  function preencherCondicoesComInstalacao() {
    document.getElementById("condicoesGerais").value = `Condi√ß√µes Gerais:
‚Ä¢ A validade deste or√ßamento √© de 7 dias.
‚Ä¢ Os valores podem sofrer altera√ß√µes caso haja mudan√ßas nas medidas ou especifica√ß√µes informadas pelo cliente.
‚Ä¢ A instala√ß√£o ser√° realizada em hor√°rio comercial (7h √†s 17h); servi√ßos fora desse per√≠odo ter√£o custo adicional.
‚Ä¢ O faturamento ser√° realizado exclusivamente como produto, com a emiss√£o de Nota Fiscal de Produto (NF-e). N√£o ser√° emitida Nota Fiscal de Servi√ßo (NFS-e).
‚Ä¢ Caso o or√ßamento inclua vidros e/ou calhas, o pagamento e faturamento dever√£o ser realizados pela contratante, sendo que a contratada ir√° apenas intermediar e realizar a instala√ß√£o do pedido.`;
  }

  function preencherCondicoesSemInstalacao() {
    document.getElementById("condicoesGerais").value = `Condi√ß√µes Gerais:
‚Ä¢ A validade deste or√ßamento √© de 7 dias.
‚Ä¢ Os valores podem sofrer altera√ß√µes caso haja mudan√ßas nas medidas ou especifica√ß√µes informadas pelo cliente.
‚Ä¢ N√£o incluso medi√ß√£o, transporte e instala√ß√£o. Pe√ßas devem ser retiradas na empresa.
‚Ä¢ O faturamento ser√° realizado exclusivamente como produto, com a emiss√£o de Nota Fiscal de Produto (NF-e). N√£o ser√° emitida Nota Fiscal de Servi√ßo (NFS-e).
‚Ä¢ Caso o or√ßamento inclua vidros e/ou calhas, o pagamento e faturamento dever√£o ser realizados pela contratante, sendo que a contratada ir√° apenas intermediar e realizar a produ√ß√£o do pedido.`;
  }

  function preencherCondicoesSemTampo() {
    console.log( "teste")
    document.getElementById("condicoesGerais").value = `Condi√ß√µes Gerais:
‚Ä¢ A validade deste or√ßamento √© de 7 dias.
‚Ä¢ Os valores podem sofrer altera√ß√µes caso haja mudan√ßas nas medidas ou especifica√ß√µes informadas pelo cliente.
‚Ä¢ N√£o incluso medi√ß√£o, transporte e instala√ß√£o. Pe√ßas devem ser retiradas na empresa.
‚Ä¢ N√£o incluso tampo.
‚Ä¢ O faturamento ser√° realizado exclusivamente como produto, com a emiss√£o de Nota Fiscal de Produto (NF-e). N√£o ser√° emitida Nota Fiscal de Servi√ßo (NFS-e).
‚Ä¢ Caso o or√ßamento inclua vidros e/ou calhas, o pagamento e faturamento dever√£o ser realizados pela contratante, sendo que a contratada ir√° apenas intermediar e realizar a produ√ß√£o do pedido.`;
  }
</script>

  <script>
              const nomeOrigemInput = document.getElementById("nomeOrigem");
              const codigoOrigemInput = document.getElementById("codigoOrigem");
              const telefoneOrigemInput = document.getElementById("telefoneOrigem");
              const emailOrigemInput = document.getElementById("emailOrigem");
              const comissaoInput = document.getElementById("comissaoArquiteto");
              const sugestoesOrigem = document.getElementById("sugestoesOrigem");

              nomeOrigemInput.addEventListener("input", async () => {
                const termo = nomeOrigemInput.value.trim();

                if (termo.length < 3) {
                  sugestoesOrigem.style.display = "none";
                  return;
                }

                try {
                  const resposta = await fetch("https://ulhoa-0a02024d350a.herokuapp.com/clientes/visualizar");
                  const clientes = await resposta.json();

                  const resultados = clientes.filter(c =>
                    (c.nome_fantasia || "").toLowerCase().includes(termo.toLowerCase()) ||
                    (c.razao_social || "").toLowerCase().includes(termo.toLowerCase())
                  );

                  sugestoesOrigem.innerHTML = "";
                  resultados.forEach(cliente => {
                    const item = document.createElement("li");
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = `${cliente.nome_fantasia || cliente.razao_social}`;
                    item.dataset.nome = cliente.nome_fantasia || cliente.razao_social;
                    item.dataset.codigo = cliente.codigo_cliente_omie || "";
                    item.dataset.telefone = cliente.telefone || "";
                    item.dataset.email = cliente.email || "";
                    item.dataset.comissao = cliente.comissao || "";

                    item.addEventListener("click", () => {
                      nomeOrigemInput.value = item.dataset.nome;
                      codigoOrigemInput.value = item.dataset.codigo;
                      telefoneOrigemInput.value = item.dataset.telefone;
                      emailOrigemInput.value = item.dataset.email;
                      comissaoInput.value = item.dataset.comissao;
                      sugestoesOrigem.style.display = "none";
                    });

                    sugestoesOrigem.appendChild(item);
                  });

                  sugestoesOrigem.style.display = resultados.length ? "block" : "none";
                } catch (error) {
                  console.error("Erro ao buscar clientes:", error);
                  sugestoesOrigem.style.display = "none";
                }
              });

              document.addEventListener("click", (event) => {
                if (!sugestoesOrigem.contains(event.target) && event.target !== nomeOrigemInput) {
                  sugestoesOrigem.style.display = "none";
                }
              });
            </script>

          </div>


    <!-- Container de busca centralizado -->
    <div class="search-container d-flex justify-content-center align-items-center gap-3 mb-4">
      <span class="material-icons-outlined">search</span>
      <input type="text" id="product-search" class="form-control" placeholder="Pesquisar produtos..." >
      <div class="dropdown">
        <button class="btn btn-outline-dark dropdown-toggle" type="button" id="dropdownClassesBtn" data-bs-toggle="dropdown" aria-expanded="false">
          Escolher Classe
        </button>
        <ul class="dropdown-menu" id="dropdownClassesList" aria-labelledby="dropdownClassesBtn">
          <!-- itens din√¢micos -->
        </ul>
      </div>
    </div>

 <div id="grupo-controles" class="grupo-controles">
      <h4>Exibir Grupos:</h4>
      <div id="grupo-checkboxes"></div>
    </div>

    <div class="table-container">
      <h3>Produtos Dispon√≠veis</h3>
      <table id="search-results" class="table">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Custo</th>
            <th>Pre√ßo</th>
            <th>Codigo Omie</th>
            <th>Detalhes</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
<div class="search-container d-flex justify-content-center align-items-center gap-3 mb-4">
  <span class="material-icons-outlined">search</span>
  <input type="text" id="product-search" class="form-control" placeholder="Pesquisar produtos...">

  <!-- Bot√£o com dropdown de classes -->
  <div class="dropdown">
    <button class="btn btn-outline-dark dropdown-toggle" type="button" id="dropdownClassesBtn" data-bs-toggle="dropdown" aria-expanded="false">
     Produto Acabado
    </button>
    <ul class="dropdown-menu" id="dropdownClassesList" aria-labelledby="dropdownClassesBtn"><li><a class="dropdown-item" href="#">Espera</a></li><li><a class="dropdown-item" href="#">Fechamento Frontal</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Bot√£o</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Calha Ferreira Ulhoa</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Calha Infinity</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Canaleta </a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Garra</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Montante H</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Prote√ß√£o</a></li><li><a class="dropdown-item" href="#">Guarda Corpo - Spider</a></li><li><a class="dropdown-item" href="#">Instala√ß√£o</a></li><li><a class="dropdown-item" href="#">Perfil U</a></li><li><a class="dropdown-item" href="#">Pergolado</a></li><li><a class="dropdown-item" href="#">Porta / Port√£o / Portinhola</a></li><li><a class="dropdown-item" href="#">Projetos Especiais</a></li><li><a class="dropdown-item" href="#">Revestimento</a></li><li><a class="dropdown-item" href="#">Vidro</a></li><li><a class="dropdown-item" href="#">Corrim√£o</a></li><li><a class="dropdown-item" href="#">Instala√ß√£o</a></li></ul>
  </div>
</div>
    <div class="table-container">
      <h3>Produtos Selecionados</h3>
      <table id="included-products" class="table">
        <tbody></tbody>
      </table>
      <div id="included-products-container"></div>
    </div>

    <footer id="footer-total" class="text-center bg-light border-top py-3">
      <strong>Valor Final da Proposta:</strong>
      <span id="valor-total-proposta" class="text-success">R$ 0,00</span>
    </footer>
  </main>


  
  <script>

function carregarPropostaEPreencherTabela() {
  fetch('https://ulhoa-0a02024d350a.herokuapp.com/api/propostas/')
    .then(res => res.json())
    .then(propostas => {
      const modelos = propostas.filter(p => p.tipoProposta === "modelo");

      if (!modelos.length) {
        console.error("‚ùå Nenhuma proposta com tipo 'modelo' encontrada.");
        return;
      }

      const proposta = modelos[modelos.length - 1];
      console.log("üì¶ Proposta carregada:", proposta);

      const campos = proposta.camposFormulario || {};

      const preencher = (id, valor) => {
        const el = document.getElementById(id);
        if (el) el.value = valor ?? "";
      };

      // üî∑ Campos principais
      preencher("nome", campos.nomeCliente);
      preencher("cpfCnpj", campos.cpfCnpj);
      preencher("endereco", campos.endereco);
      preencher("idClienteOmie", campos.idClienteOmie);
      preencher("descricao", campos.descricao);
      preencher("numeroComplemento", campos.numeroComplemento);
      preencher("enderecoEntrega", campos.enderecoEntrega);
      preencher("telefone", campos.telefone);
      preencher("arquiteto", campos.arquiteto);
      preencher("codigoArquiteto", campos.codigoArquiteto); // corrigido
      preencher("dataEntrega", campos.dataEntrega);
      preencher("selectVendedor", campos.vendedor);
      preencher("tipoPagamento", campos.tipoPagamento);
      preencher("desconto", campos.desconto);

      // üî∑ Informa√ß√µes do Or√ßamento
      preencher("numeroOrcamento", campos.numeroOrcamento);
      preencher("dataOrcamento", campos.dataOrcamento);
      preencher("origemCliente", campos.origemCliente);
      preencher("nomeOrigem", campos.nomeOrigem);
      preencher("codigoOrigem", campos.codigoOrigem);
      preencher("telefoneOrigem", campos.telefoneOrigem);
      preencher("emailOrigem", campos.emailOrigem);
      preencher("comissaoArquiteto", campos.comissaoArquiteto);

      // üî∑ Endere√ßo da Obra
      preencher("cep", campos.cep);
      preencher("rua", campos.rua);
      preencher("numero", campos.numero);
      preencher("complemento", campos.complemento);
      preencher("bairro", campos.bairro);
      preencher("cidade", campos.cidade);
      preencher("estado", campos.estado);

      // üî∑ Equipe Interna
      preencher("vendedorResponsavel", campos.vendedorResponsavel);
      preencher("operadorInterno", campos.operadorInterno);

      // üî∑ Produtos e Condi√ß√µes
      preencher("produtosValores", campos.produtosValores);
      preencher("prazosArea", campos.prazosArea);
      preencher("condicaoPagamento", campos.condicaoPagamento);
      preencher("condicoesGerais", campos.condicoesGerais);

      // üî∑ Produtos agrupados
      const produtosTransformados = [];
      window.groupPopupsData = {};

      proposta.grupos.forEach(grupo => {
        const grupoId = `grupo-${grupo.nome.replace(/\s+/g, '-').toLowerCase()}`;

        groupPopupsData[grupoId] = {
          ...(grupo.parametros || {}),
          groupSaleFormula: grupo.parametros?.groupSaleFormula || ""
        };

        grupo.itens.forEach(item => {
          const quantidade = parseFloat(item.quantidade || 1);
          produtosTransformados.push({
            name: item.nome_produto,
            price: item.preco,
            cost: quantidade > 0 ? item.custo / quantidade : 0,
            quantity: quantidade,
            priceFormula: item.formula_preco || "",
            costFormula: "",
            adjustedQuantityFormula: item.formula_quantidade || "",
            class: grupo.nome,
            _id: item._id,
            index: produtosTransformados.length,
            codigo_produto: item.codigo_omie || ""
          });
        });
      });

      window.includedProducts = produtosTransformados;
      renderIncludedProducts();
    })
    .catch(err => {
      console.error("‚ùå Erro ao carregar propostas:", err);
    });
}

carregarPropostaEPreencherTabela();



  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Seleciona todos os inputs dentro de qualquer linha .extra-summary-row
    const campos = document.querySelectorAll(".extra-summary-row input");

    campos.forEach(campo => {
      campo.addEventListener("input", () => {
        if (typeof render === "function") renderIncludedProducts();
      });

      campo.addEventListener("blur", () => {
        if (typeof render === "function") renderIncludedProducts();
      });
    });
  });
</script>

<script>
  async function gerarPaginaEnvio() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
  
    const campos = {
      nome: document.getElementById("nome")?.value || "Sem nome",
      dataEntrega: document.getElementById("dataEntrega")?.value || "",
    };
  
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("Resumo para Envio de Proposta", 105, 15, { align: "center" });
  
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text(`Cliente: ${campos.nome}`, 14, 30);
    doc.text(`Previs√£o de Entrega: ${campos.dataEntrega}`, 14, 37);
  
    const grupos = {};
  
    // Agrupa os produtos por classe (grupo)
    includedProducts.forEach(prod => {
      if (!grupos[prod.class]) grupos[prod.class] = [];
      grupos[prod.class].push(prod);
    });
  
    let startY = 50;
  
    for (const grupo in grupos) {
      const produtos = grupos[grupo];
      const primeiro = produtos[0];
      const quantidadeTotal = produtos.reduce((sum, p) => sum + parseFloat(p.quantity || 0), 0);
      const custoTotal = produtos.reduce((sum, p) => sum + parseFloat(p.cost || 0) * parseFloat(p.quantity || 0), 0);
  
      doc.setFillColor(240);
      doc.setFontSize(12);
      doc.setTextColor(40);
      doc.setDrawColor(200);
      doc.rect(14, startY - 5, 180, 10, 'F');
      doc.text(`Grupo: ${grupo}`, 16, startY + 2);
  
      doc.autoTable({
        startY: startY + 5,
        margin: { left: 14, right: 14 },
        styles: {
          fontSize: 10,
          cellPadding: 3,
          halign: 'left',
          valign: 'middle',
          lineColor: [200, 200, 200],
          lineWidth: 0.1,
          textColor: 50
        },
        headStyles: {
          fillColor: [220, 220, 220],
          textColor: 20,
          fontStyle: 'bold',
        },
        body: [
          [
            primeiro.name,
            primeiro.codigo_produto || "-",
            `R$ ${custoTotal.toFixed(2)}`,
            quantidadeTotal
          ]
        ],
        head: [["Produto", "C√≥digo Omie", "Valor Total", "Quantidade"]],
        theme: 'grid'
      });
  
      startY = doc.lastAutoTable.finalY + 10;
    }
  
    doc.save(`envio_proposta_${campos.nome.replace(/\s+/g, '_')}.pdf`);
  }
  </script>
  
<script>
  function preencherPrazosPorArea() {
    console.log( "Preenchimento ")
    const texto = `√Årea ___: _____ dias √∫teis ap√≥s aprova√ß√£o do respectivo projeto.

Vidro
√Årea ___: _____ dias √∫teis ap√≥s instala√ß√£o da respectiva estrutura.`;

    const campo = document.getElementById("prazosArea");
    if (campo) campo.value = texto;
  }

  // Aguarda o carregamento da p√°gina e depois espera 3 segundos
  window.addEventListener("DOMContentLoaded", () => {
    setTimeout(preencherPrazosPorArea, 5000);

  });

  
function carregarPropostaEPreencherTabela() {
  const urlParams = new URLSearchParams(window.location.search);
  const propostaId = urlParams.get("id");

  if (!propostaId) {
    console.error("‚ùå Nenhum ID de proposta na URL.");
    return;
  }

  fetch('https://ulhoa-0a02024d350a.herokuapp.com/api/propostas/')
    .then(res => res.json())
    .then(propostas => {
      const proposta = propostas.find(p => p._id === propostaId);

      if (!proposta) {
        console.error("‚ùå Proposta n√£o encontrada.");
        return;
      }

      const campos = proposta.camposFormulario || {};

      // Preenche todos os campos se existirem
      const preencherCampo = (id, valor) => {
        const el = document.getElementById(id);
        if (el) el.value = valor ?? "";
      };

      // üß© Campos do formul√°rio
      preencherCampo("nome", campos.nomeCliente);
      preencherCampo("cpfCnpj", campos.cpfCnpj);
      preencherCampo("endereco", campos.endereco);
      preencherCampo("idClienteOmie", campos.idClienteOmie);
      preencherCampo("descricao", campos.descricao);
      preencherCampo("numeroComplemento", campos.numeroComplemento);
      preencherCampo("enderecoEntrega", campos.enderecoEntrega);
      preencherCampo("telefone", campos.telefone);
      preencherCampo("arquiteto", campos.arquiteto);
      preencherCampo("codigo_arqeuiteto", campos.codigoArquiteto);
      preencherCampo("dataEntrega", campos.dataEntrega);
      preencherCampo("selectVendedor", campos.vendedor);
      preencherCampo("tipoPagamento", campos.tipoPagamento);
      preencherCampo("desconto", campos.desconto);

      // üß© Informa√ß√µes do Or√ßamento
      preencherCampo("numeroOrcamento", campos.numeroOrcamento);
      preencherCampo("dataOrcamento", campos.dataOrcamento);
      preencherCampo("origemCliente", campos.origemCliente);
      preencherCampo("nomeOrigem", campos.nomeOrigem);
      preencherCampo("codigoOrigem", campos.codigoOrigem);
      preencherCampo("telefoneOrigem", campos.telefoneOrigem);
      preencherCampo("emailOrigem", campos.emailOrigem);
      preencherCampo("comissaoArquiteto", campos.comissaoArquiteto);

      // üß© Endere√ßo da Obra
      preencherCampo("cep", campos.cep);
      preencherCampo("rua", campos.rua);
      preencherCampo("numero", campos.numero);
      preencherCampo("complemento", campos.complemento);
      preencherCampo("bairro", campos.bairro);
      preencherCampo("cidade", campos.cidade);
      preencherCampo("estado", campos.estado);

      // üß© Equipe Interna
      preencherCampo("vendedorResponsavel", campos.vendedorResponsavel);
      preencherCampo("operadorInterno", campos.operadorInterno);

      // üß© Produtos e Condi√ß√µes
      preencherCampo("produtosValores", campos.produtosValores);
      preencherCampo("prazosArea", campos.prazosArea);
      preencherCampo("condicaoPagamento", campos.condicaoPagamento);
      preencherCampo("condicoesGerais", campos.condicoesGerais);

      // Produtos agrupados
      const produtosTransformados = [];
      window.groupPopupsData = {};

      proposta.grupos.forEach(grupo => {
        const grupoId = `grupo-${grupo.nome.replace(/\s+/g, '-').toLowerCase()}`;
        groupPopupsData[grupoId] = {
          ...(grupo.parametros || {}),
          groupSaleFormula: grupo.parametros?.groupSaleFormula || ""
        };

        grupo.itens.forEach(item => {
          const quantidade = item.quantidade || 1;
          produtosTransformados.push({
            name: item.nome_produto,
            price: item.preco,
            cost: quantidade > 0 ? item.custo / quantidade : 0,
            quantity: quantidade,
            priceFormula: item.formula_preco || "",
            costFormula: "", // n√£o usado
            adjustedQuantityFormula: item.formula_quantidade || "",
            class: grupo.nome,
            _id: item._id,
            index: produtosTransformados.length,
            codigo_produto: item.codigo_omie || ""
          });
        });
      });

      window.includedProducts = produtosTransformados;
      renderIncludedProducts();
    })
    .catch(err => {
      console.error("‚ùå Erro ao carregar propostas:", err);
    });
}

carregarPropostaEPreencherTabela() 
</script>


</body>
</html>


